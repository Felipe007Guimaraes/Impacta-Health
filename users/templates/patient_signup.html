{% load static %}

//TODO: Separar os headers e foots para usar globalmente...
{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realize seu Cadastro</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
  <header>
    <!-- Cabeçalho da página, se necessário -->
  </header>
  <main>
    <div class="registration-form">
      <h2>Registro de Usuário</h2>
      <form method="post">
        {% csrf_token %}
        <div class="form-group">
          <input type="text" name="{{ form.username.name }}" id="{{ form.username.id_for_label }}"
            placeholder="Seu nome de usuário">
            <div class="invalid-feedback username-feedback"></div>
        </div>
        <div class="form-group">
          <input type="text" name="{{ form.first_name.name }}" id="{{ form.first_name.id_for_label }}"
            placeholder="Seu primeiro nome">
        </div>
        <div class="form-group">
          <input type="text" name="{{ form.last_name.name }}" id="{{ form.last_name.id_for_label }}"
            placeholder="Seu sobrenome">
        </div>
        <div class="form-group">
          <input type="email" name="{{ form.email.name }}" id="{{ form.email.id_for_label }}"
            placeholder="Seu endereço de email">
            <div class="invalid-feedback email-feedback"></div>
        </div>
        <div class="form-group">
          <input type="password" name="{{ form.password1.name }}" id="{{ form.password1.id_for_label }}"
            placeholder="Sua senha">
        </div>
        <div class="form-group">
          <input type="password" name="{{ form.password2.name }}" id="{{ form.password2.id_for_label }}"
            placeholder="Confirme sua senha">
            <div class="invalid-feedback password-feedback"></div>
        </div>
        <div class="form-group">
          <button type="submit" class="boxed-btn3">Confirm</button>
        </div>
      </form>
    </div>
  </main>
  <footer>
    <!-- Rodapé da página, se necessário -->
  </footer>
</body>
</html>
{% endblock %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script>
  $(document).ready(function () {
    var usernameField = $('#id_username');
    var emailField = $('#id_email');
    var passwordField1 = $('#id_password1');
    var passwordField2 = $('#id_password2');
    var firstNameField = $('#id_first_name');
    var lastNameField = $('#id_last_name');

    function showFeedback(element, message) {
      element.text(message).fadeIn();
    }
    function hideFeedback(element) {
      element.fadeOut();
    }
    function handleFieldInput(field, feedbackElement, validationUrl, successCallback) {
      field.on('input', _.debounce(function () {
        var value = field.val();

        if (value.trim() !== '') {
          $.ajax({
            url: validationUrl,
            type: 'POST',
            data: { [field.attr('name')]: value },
            success: function (response) {
              if (successCallback) {
                successCallback(response, feedbackElement);
              }
            },
            error: function (xhr, textStatus, errorThrown) {
              if (xhr.status === 400) {
                showFeedback(feedbackElement, xhr.responseJSON[field.attr('name')][0]);
              }
            }
          });
        } else {
          hideFeedback(feedbackElement);
        }
      }, 1000));
    }
    function markFieldAsError(field) {
      field.addClass('error-field');
      field.next('.error-message').text('Este campo é obrigatório.').fadeIn();
    }
    function clearFieldError(field) {
      field.removeClass('error-field');
      field.next('.error-message').text('').fadeOut();
    }
    handleFieldInput(usernameField, $('.username-feedback'), '{% url "users:signup-verify" %}', function (response, feedbackElement) {
      if (response.username_exists) {
        showFeedback(feedbackElement, 'Username already exists.');
      } else {
        hideFeedback(feedbackElement);
      }

      if (response.username_error) {
        showFeedback(feedbackElement, response.username_error);
      }
    });
    handleFieldInput(emailField, $('.email-feedback'), '{% url "users:signup-verify" %}', function (response, feedbackElement) {
      if (response.email_exists) {
        showFeedback(feedbackElement, 'Email already exists.');
      } else {
        hideFeedback(feedbackElement);
      }

      if (response.email_error) {
        showFeedback(feedbackElement, response.email_error);
      }
    });
    passwordField2.on('input', function () {
      var password1 = passwordField1.val();
      var password2 = passwordField2.val();

      if (password2.trim() !== '') {
        if (password1 !== password2) {
          showFeedback($('.password-feedback'), 'Passwords do not match.');
        } else {
          hideFeedback($('.password-feedback'));
        }
      } else {
        hideFeedback($('.password-feedback'));
        markFieldAsError(passwordField2);
        shakeFieldWithError(passwordField2);
      }
    });
    var form = $('form');
    form.on('submit', function (e) {
      var isValid = true;
      function shakeFieldWithError(field) {
        field.addClass('error-field error-shake');
      }
      form.find('.invalid-feedback').each(function () {
        var feedbackElement = $(this);
        var field = feedbackElement.siblings('input');
        if (feedbackElement.is(':visible')) {
          isValid = false;
          markFieldAsError(field);
          shakeFieldWithError(field);
        } else {
          clearFieldError(field);
        }
      });
      form.find('input').each(function () {
        var inputField = $(this);
        if (inputField.val().trim() === '') {
          isValid = false;
          markFieldAsError(inputField);
          shakeFieldWithError(inputField);
        } else {
          clearFieldError(inputField);
        }
      });
      if (firstNameField.val().trim() === '') {
        isValid = false;
        markFieldAsError(firstNameField);
        shakeFieldWithError(firstNameField);
      } else {
        clearFieldError(firstNameField);
      }

      if (lastNameField.val().trim() === '') {
        isValid = false;
        markFieldAsError(lastNameField);
        shakeFieldWithError(lastNameField);
      } else {
        clearFieldError(lastNameField);
      }
      if (!isValid) {
        e.preventDefault();
        setTimeout(function () {
          form.find('.error-shake').removeClass('error-shake');
        }, 1000);
      }
    });
  });
</script>